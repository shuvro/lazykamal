#!/bin/bash
# Pre-push hook: runs the same checks as CI before pushing

set -e

echo "ðŸ” Running pre-push checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_pass() {
    echo -e "${GREEN}âœ“${NC} $1"
}

check_fail() {
    echo -e "${RED}âœ—${NC} $1"
    echo -e "${RED}Push aborted. Fix the issues above and try again.${NC}"
    exit 1
}

# 1. Check formatting
echo "Checking go fmt..."
UNFORMATTED=$(gofmt -l . 2>&1 | grep -v vendor || true)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}The following files are not formatted:${NC}"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: go fmt ./..."
    check_fail "go fmt"
else
    check_pass "go fmt"
fi

# 2. Run go vet
echo "Running go vet..."
if go vet ./... 2>&1; then
    check_pass "go vet"
else
    check_fail "go vet"
fi

# 3. Build
echo "Building..."
if go build -v ./... 2>&1; then
    check_pass "go build"
else
    check_fail "go build"
fi

# 4. Run tests
echo "Running tests..."
if go test -race ./... 2>&1; then
    check_pass "go test"
else
    check_fail "go test"
fi

# 5. Run golangci-lint if available
if command -v golangci-lint &> /dev/null; then
    echo "Running golangci-lint..."
    if golangci-lint run ./... 2>&1; then
        check_pass "golangci-lint"
    else
        check_fail "golangci-lint"
    fi
else
    echo -e "${YELLOW}âš ${NC} golangci-lint not installed, skipping (CI will still run it)"
    echo "  Install: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
fi

echo ""
echo -e "${GREEN}All checks passed! Pushing...${NC}"
